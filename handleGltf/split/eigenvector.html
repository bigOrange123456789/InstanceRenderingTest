<!DOCTYPE html>
<html lang="en">
<head>
    <title>静态模型处理</title>
    <meta charset="utf-8">
</head>
<body>
<script src="js/threeLib/three.js"></script>
<script src="js/threeLib/GLTFLoader.js"></script>
<script src="js/threeLib/GLTFExporter.js"></script>

<script src="js/myLib/Download.js"></script>
<script src="js/GlbHandle.js"></script>
<script src="js/myLib/DuplicateRemoval.js"></script>
<script src="js/myLib/MaterialHandle.js"></script>
<script src="js/myLib/GlbSplit.js"></script>
<script src="js/myLib/InDe.js"></script>
<script src="js/myLib/ResourceManager.js"></script>

<script>
    var path=
        prompt(
            "Please enter path:",
            "../../../_DATA_/model/"
        );
    var names;
    var eigenvectors=[];
    var loader = new THREE.XHRLoader(THREE.DefaultLoadingManager);
    loader.load("names.json", function (data) {
        names=JSON.parse(data);
        computeEigenvector(0);
    });
    function computeEigenvector(urls_index) {
        new THREE.GLTFLoader().load(path+names[urls_index], (glb) => {
            var scene=new THREE.Scene();
            for(i=glb.scene.children.length-1;i>=0;i--)
                scene.add(glb.scene.children[i]);
            var eigenvector=new GlbHandle().eigenvector({scene:scene},10);
            eigenvectors.push(eigenvector)
            if(urls_index+1<names.length){
                console.log("特征向量计算进度:"+urls_index+"/"+names.length)
                computeEigenvector(urls_index+1);
            }else{
                console.log("开始计算重复性！")
                checkingDuplicate();
            }
        });
    }
    function checkingDuplicate() {
        var result = {}
        for (i = 0; i < names.length; i++) {
            result[names[i]] = {
                url: names[i],
                matrix: eigenvectors[i].matrix.elements
            }
        }
        for (var lll = 0; lll < names.length; lll++) {
            console.log("重用性计算进度:" + lll + "/" + names.length)
            for (var mmm = 0; mmm < lll; mmm++) {
                var b1 = eigenvectors[lll].boundingBox;
                var b2 = eigenvectors[mmm].boundingBox;
                var variance = new GlbHandle().variance(eigenvectors[lll].vector, eigenvectors[mmm].vector)
                console.log(variance)

                if (variance < 0.01 &&
                    Math.abs(b1.min.x - b2.min.x) < 0.01 &&
                    Math.abs(b1.min.y - b2.min.y) < 0.01 &&
                    Math.abs(b1.min.z - b2.min.z) < 0.01 &&
                    Math.abs(b1.max.x - b2.max.x) < 0.01 &&
                    Math.abs(b1.max.y - b2.max.y) < 0.01 &&
                    Math.abs(b1.max.z - b2.max.z)) {
                    if (variance < 0.005) {
                        result[names[lll]].url = names[mmm];
                        break;
                    }
                }
            }
            console.log(result)
            download(result, "result.json")
        }
    }
    function download(data,name){
        link = document.createElement('a');
        link.style.display = 'none';
        document.body.appendChild(link);
        link.href = URL.createObjectURL(new Blob([JSON.stringify(data)], { type: 'text/plain' }));
        link.download =name;
        link.click();
    }
</script>

</body>
