<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>PathFinding.js</title>

    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./lib/themes/jquery.ui.all.css" />

    <script type="text/javascript" src="./lib/raphael-min.js"></script>
    <script type="text/javascript" src="./lib/es5-shim.min.js"></script>
    <script type="text/javascript" src="./lib/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="./lib/state-machine.min.js"></script>
    <script type="text/javascript" src="./lib/async.min.js"></script>

    <script type="text/javascript" src="./lib/ui/jquery.ui.core.min.js"></script>
    <script type="text/javascript" src="./lib/ui/jquery.ui.widget.min.js"></script>
    <script type="text/javascript" src="./lib/ui/jquery.ui.mouse.min.js"></script>
    <script type="text/javascript" src="./lib/ui/jquery.ui.draggable.min.js"></script>
    <script type="text/javascript" src="./lib/ui/jquery.ui.accordion.min.js"></script>
    <script type="text/javascript" src="./lib/ui/jquery.ui.slider.min.js"></script>

    <script type="text/javascript" src="../dist/main.js"></script>


  </head>
  <script>
    function doNothing(){
      window.event.returnValue=false;
      //return false;
    }
  </script>
  <body oncontextmenu="doNothing()">
  <script type="text/javascript" src="./js/controller.js"></script>
  <script type="text/javascript" src="./js/view.js"></script>
  <script type="text/javascript" src="./js/panel.js"></script>
  <script type="text/javascript" src="./js/main.js"></script>

    <div id="draw_area"></div>

    <div id="instructions_panel" class="panel">
      <header>
        <h2 class="header_title">Instructions</h2>
        <span id="hide_instructions">hide</span>
      </header>
      Click within the <span class="white">white</span> grid and drag your mouse to draw obstacles. <br>
      Drag the <span class="green">green</span> node to set the start position. <br>
      Drag the <span class="red">red</span> node to set the end position. <br>
      Choose an algorithm from the right-hand panel. <br>
      Click Start Search in the lower-right corner to start the animation.
    </div>

    <div id="algorithm_panel" class="panel right_panel">
      <header><h2 class="header_title">Select Algorithm</h2></header>

      <div class="accordion">
        <h3 ><a href="#">Map</a></h3>
        <div  class="finder_section">
          <header class="option_header">
            <h3>load map</h3>
          </header>
          <div class="sub_options">
            <button id="map0" style="width:150px;">FJK_1</button>
          </div>
          <div class="sub_options">
            <button id="map1" style="width:150px;">FJK_2</button>
          </div>
          <div class="sub_options">
            <button id="map2" style="width:150px;">FJK_3</button>
          </div>
          <div class="sub_options">
            <button id="map3" style="width:150px;">HSH_1_100</button>
          </div>
          <div class="sub_options">
            <button id="map4" style="width:150px;">HSH_1_200</button>
          </div>
          <div class="sub_options">
            <button id="map5" style="width:150px;">HSH_1_300</button>
          </div>
          <div class="sub_options">
            <button id="map6" style="width:150px;">HSH_1_400</button>
          </div>
          <div class="sub_options">
            <button id="map7" style="width:150px;">grid1</button>
          </div>
        </div>

        <h3 id="astar_header"><a href="#">A*</a></h3>
        <div id="astar_section" class="finder_section">
          <header class="option_header">
            <h3>Heuristic</h3>
          </header>
          <div id="astar_heuristic" class="sub_options">
            <input type="radio" name="astar_heuristic" value="manhattan" checked />
            <label class="option_label">Manhattan</label> <br>
            <input type="radio" name="astar_heuristic" value="euclidean"/>
            <label class="option_label">Euclidean</label> <br>
            <input type="radio" name="astar_heuristic" value="octile"/>
            <label class="option_label">Octile</label> <br>
            <input type="radio" name="astar_heuristic" value="chebyshev"/>
            <label class="option_label">Chebyshev</label> <br>
          </div>

          <header class="option_header">
            <h3>Options</h3>
          </header>
          <div class="optional sub_options">
            <input type="checkbox" class="allow_diagonal" checked>
            <label class="option_label">Allow Diagonal</label> <br>
            <input type="checkbox" class="bi-directional">
            <label class="option_label">Bi-directional</label> <br>
            <input type="checkbox" class="dont_cross_corners">
            <label class="option_label">Don't Cross Corners</label> <br>
            <input class="spinner" name="astar_weight" value="1">
            <label class="option_label">Weight</label> <br>
          </div>
        </div>

        <h3 id="ida_header"><a href="#">IDA*</a></h3>
        <div id="ida_section" class="finder_section">
          <header class="option_header">
            <h3>Heuristic</h3>
          </header>
          <div id="ida_heuristic" class="sub_options">
            <input type="radio" name="ida_heuristic" value="manhattan" checked />
            <label class="option_label">Manhattan</label> <br>
            <input type="radio" name="ida_heuristic" value="euclidean"/>
            <label class="option_label">Euclidean</label> <br>
            <input type="radio" name="ida_heuristic" value="octile"/>
            <label class="option_label">Octile</label> <br>
            <input type="radio" name="ida_heuristic" value="chebyshev"/>
            <label class="option_label">Chebyshev</label> <br>
          </div>
          <header class="option_header">
            <h3>Options</h3>
          </header>
          <div class="optional sub_options">
            <input type="checkbox" class="allow_diagonal" checked>
            <label class="option_label">Allow Diagonal</label> <br>
            <input type="checkbox" class="dont_cross_corners">
            <label class="option_label">Don't Cross Corners</label> <br>
            <input class="spinner" name="astar_weight" value="1">
            <label class="option_label">Weight</label> <br>
            <input class="spinner" name="time_limit" value="10">
            <label class="option_label">Seconds limit</label> <br>
            <input type="checkbox" class="track_recursion" checked />
            <label class="option_label">Visualize recursion</label> <br>
          </div>
        </div>

        <h3 id="breadthfirst_header"><a href="#">Breadth-First-Search</a></h3>
        <div id="breadthfirst_section" class="finder_section">
          <header class="option_header">
            <h3>Options</h3>
          </header>
          <div class="optional sub_options">
            <input type="checkbox" class="allow_diagonal" checked>
            <label class="option_label">Allow Diagonal</label> <br>
            <input type="checkbox" class="bi-directional">
            <label class="option_label">Bi-directional</label> <br>
            <input type="checkbox" class="dont_cross_corners">
            <label class="option_label">Don't Cross Corners</label> <br>
          </div>
        </div>

        <h3 id="bestfirst_header"><a href="#">Best-First-Search</a></h3>
        <div id="bestfirst_section" class="finder_section">
          <header class="option_header">
            <h3>Heuristic</h3>
          </header>
          <div id="bestfirst_heuristic" class="sub_options">
            <input type="radio" name="bestfirst_heuristic" value="manhattan" checked />
            <label class="option_label">Manhattan</label> <br>
            <input type="radio" name="bestfirst_heuristic" value="euclidean"/>
            <label class="option_label">Euclidean</label> <br>
            <input type="radio" name="bestfirst_heuristic" value="octile"/>
            <label class="option_label">Octile</label> <br>
            <input type="radio" name="bestfirst_heuristic" value="chebyshev"/>
            <label class="option_label">Chebyshev</label> <br>
          </div>

          <header class="option_header">
            <h3>Options</h3>
          </header>
          <div class="optional sub_options">
            <input type="checkbox" class="allow_diagonal" checked>
            <label class="option_label">Allow Diagonal</label> <br>
            <input type="checkbox" class="bi-directional">
            <label class="option_label">Bi-directional</label> <br>
            <input type="checkbox" class="dont_cross_corners">
            <label class="option_label">Don't Cross Corners</label> <br>
          </div>
        </div>

        <h3 id="dijkstra_header"><a href="#">Dijkstra</a></h3>
        <div id="dijkstra_section" class="finder_section">
          <header class="option_header">
            <h3>Options</h3>
          </header>
          <div class="optional sub_options">
            <input type="checkbox" class="allow_diagonal" checked>
            <label class="option_label">Allow Diagonal</label> <br>
            <input type="checkbox" class="bi-directional">
            <label class="option_label">Bi-directional</label> <br>
            <input type="checkbox" class="dont_cross_corners">
            <label class="option_label">Don't Cross Corners</label> <br>
          </div>
        </div>

        <h3 id="jump_point_header"><a href="#">Jump Point Search</a></h3>
        <div id="jump_point_section" class="finder_section">
          <header class="option_header">
            <h3>Heuristic</h3>
          </header>
          <div id="jump_point_heuristic" class="sub_options">
            <input type="radio" name="jump_point_heuristic" value="manhattan" checked />
            <label class="option_label">Manhattan</label> <br>
            <input type="radio" name="jump_point_heuristic" value="euclidean"/>
            <label class="option_label">Euclidean</label> <br>
            <input type="radio" name="jump_point_heuristic" value="octile"/>
            <label class="option_label">Octile</label> <br>
            <input type="radio" name="jump_point_heuristic" value="chebyshev"/>
            <label class="option_label">Chebyshev</label> <br>
          </div>
          <header class="option_header">
            <h3>Options</h3>
          </header>
          <div class="optional sub_options">
            <input type="checkbox" class="track_recursion" checked>
            <label class="option_label">Visualize recursion</label> <br>
          </div>
        </div>

	<h3 id="orth_jump_point_header"><a href="#">Orthogonal Jump Point Search</a></h3>
        <div id="orth_jump_point_section" class="finder_section">
          <header class="option_header">
            <h3>Heuristic</h3>
          </header>
          <div id="orth_jump_point_heuristic" class="sub_options">
            <input type="radio" name="orth_jump_point_heuristic" value="manhattan" checked />
            <label class="option_label">Manhattan</label> <br>
            <input type="radio" name="orth_jump_point_heuristic" value="euclidean"/>
            <label class="option_label">Euclidean</label> <br>
            <input type="radio" name="orth_jump_point_heuristic" value="octile"/>
            <label class="option_label">Octile</label> <br>
            <input type="radio" name="orth_jump_point_heuristic" value="chebyshev"/>
            <label class="option_label">Chebyshev</label> <br>
          </div>
          <header class="option_header">
            <h3>Options</h3>
          </header>
          <div class="optional sub_options">
            <input type="checkbox" class="track_recursion" checked>
            <label class="option_label">Visualize recursion</label> <br>
          </div>
        </div>

      </div><!-- .accordion -->
    </div><!-- #algorithm_panel -->

    <div id="play_panel" class="panel right_panel">
      <button id="button1" class="control_button">Start Search</button>
      <button id="button2" class="control_button">Pause Search</button>
      <button id="button3" class="control_button">Clear Walls</button>
      <button id="download" >save map</button>
      <button id="savePath" >save path</button>
      <h2 id="myPathLength"></h2>
    </div>

    <div id="stats"></div>

    <footer>
      Project Hosted on <a href="http://github.com/qiao/PathFinding.js">Github</a>
    </footer>

  <script>
    class MachineLearning{
      //loadJson获得
      max;min;
      wall;board;
      start;end;
      //initPF获得
      grid;
      finder;
      constructor(){
      }
      load(url,finished){
        var scope=this;
        var request = new XMLHttpRequest();
        request.open("get", url);/*设置请求方法与路径*/
        request.send(null);/*不发送数据到服务器*/
        request.onload = function () {/*XHR对象获取到返回信息后执行*/
          if (request.status === 200) {/*返回状态为200，即为数据获取成功*/
            var json = JSON.parse(request.responseText);
            var arr=json.data;
            scope.wall=arr;

            var max=[arr[0][0],arr[0][1]],
                    min=[arr[0][0],arr[0][1]];
            for(var i=1;i<arr.length;i++){
              for(var j=0;j<2;j++)
                if(arr[i][j]!==null)if(arr[i][j]>max[j])max[j]=arr[i][j];
              for(j=0;j<2;j++)
                if(arr[i][j]!==null)if(arr[i][j]<min[j])min[j]=arr[i][j];
            }
            scope.max=max;
            scope.min=min;

            scope.start=json.start;
            scope.end=json.end;

            scope.board=json.board;
            scope.initPF();
            console.log(scope.grid)
            if(finished)finished();

          }
        }
      }
      initPF(){
        this.grid = new PF.Grid(20,20);//生成网格
        for(var i=0;i<this.wall.length;i++){
          this.grid.setWalkableAt(
                  this.wall[i][0],
                  this.wall[i][1],
                  false);
        }
        for(i=0;i<this.board.length;i++) {
          var I=this.board[i][0],
                  J=this.board[i][1];
          this.grid.nodes[I][J].boardAngle =this.board[i][2];
          console.log(I,J,this.grid.nodes[I][J].boardAngle)
        }/**/
        this.finder = new PF.AStarFinder({
          allowDiagonal: true,//允许对角线
          dontCrossCorners: false,//不要拐弯?
          heuristic: PF.Heuristic["manhattan"],//启发式["曼哈顿"]
          weight: 1
        });
      }

      getAngle(){
        console.log(this.grid)
        return this.train({"i":0,"j":1});
      }
      train(x){
        var w_init=0;
        var time=100;
        var step=Math.PI/180;

        var w=w_init;
        var test=[];
        for(var t=0;t<time;t++){
          x.angle=w;
          var g=this.grad(x);
          w=w-g*step;
          test.push(g);
        }
        for(t=10;t>0;t--)
          console.log(test[test.length-t]);

        return w;
      }
      grad(x0){
        var l1=this.loss(x0);
        x0.angle+=0.01;
        var l2=this.loss(x0);
        return (l2-l1)/0.01;
      }
      loss(x){//损失函数
        this.grid.nodes[x.i][x.j].boardAngle=x.angle;

        var sum=0;
        var rMax=5,cMax=5;
        var err=0;
        for(var r=0;r<rMax;r++)
          for(var c=0;c<cMax;c++){
            var l=this.find(
                    this.start[0]+c,
                    this.start[1]+c,
                    this.end[0]+r,
                    this.end[1]+r);
            if(l>0)sum+=l;
            else err++;
          }
        return sum/((rMax+1)*(cMax+1)-err);
      }
      find(start1,start2,end1,end2){//返回搜索过的区域大小为
        if(!this.grid.nodes[start1][start2].walkable)return 0;
        var grid=this.grid.clone();
        for(var i=0;i<this.grid.nodes.length;i++)
          for(var j=0;j<this.grid.nodes.length;j++){
            var angle=this.grid.nodes[i][j].boardAngle;
            if(typeof (angle)!=="undefined")
              grid.nodes[i][j].boardAngle=angle;
          }
        var path = this.finder.findPath(
                start1,start2,
                end1,end2,
                grid);
        if(path.length===0)return 0;
        else return PFAreaSize(grid);//搜索过的区域大小
        function PFAreaSize(grid0){
          var count=0;
          for(var i=0;i<grid0.nodes.length;i++){
            for(var j=0;j<grid0.nodes[i].length;j++){
              if(grid0.nodes[i][j].closed===true){
                count++;
              }
            }
          }
          return count;
        }
      }

    }
    window.ml=new MachineLearning();
  </script>
  </body>
</html>
