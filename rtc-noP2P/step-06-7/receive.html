<!DOCTYPE html>
<html lang="en">
<head>
  <title>receive4</title>
</head>
<body>
<script src="/socket.io/socket.io.js"></script>
<script src="http://youku3d.com/smart3d/lib/adapter.js"></script>
<script>
  // Connect to the signaling server
  var socket = io.connect();
  socket.on('ready',  ()=> {
    createPeerConnection()
  })
  socket.on('message', message=> {//用于接收SDP和candidate
    signalingMessageCallback(message)
  })
  function sendMessage(message) {
    socket.emit('message', message)//用于发送SDP和candidate
  }
  socket.emit('create or join', "room001")
  /****************************************************************************
   * WebRTC peer connection and data channel
   ****************************************************************************/
  var peerConn

  function signalingMessageCallback(message) {
    if (message.type === 'answer') {//receive
      console.log('receive answer : set remote sdp')
      peerConn.setRemoteDescription(new RTCSessionDescription(message), function() {}, logError)
    } else if (message.type === 'candidate') {//receive
      console.log('receive candidate : add candidate')
      console.log(message)
      peerConn.addIceCandidate(new RTCIceCandidate({
        candidate: message.candidate,
        sdpMLineIndex: message.label,
        sdpMid: message.id
      }))
    }
  }
  function createPeerConnection() {
    console.log('Creating Peer connection')
    peerConn = new RTCPeerConnection()
    peerConn.onicecandidate = function(event) {
      if (event.candidate) {
        console.log("on candidate : send candidate")
        sendMessage({
          type: 'candidate',
          label: event.candidate.sdpMLineIndex,
          id: event.candidate.sdpMid,
          candidate: event.candidate.candidate
        })
      } else {
        console.log('on candidate : End of candidates.')
      }
    }

    console.log('Creating Channel')
    onDataChannelCreated(peerConn.createDataChannel('photos'))

    console.log('creating offer')
    peerConn.createOffer().then(function(offer) {
      console.log('set local sdp')
      return peerConn.setLocalDescription(offer)
    }).then(() => {
      console.log('send local sdp')
      sendMessage(peerConn.localDescription)
    }).catch(logError)
  }
  /////////////////////////////////////////////////////////////////
  function onDataChannelCreated(channel) {
    channel.onopen = ()=>{
      console.log('channel opened!!!!!!!!!!!!!!!!!')
      window.send=channel.send
    }
    channel.onclose = ()=>console.log('Channel closed')
    channel.onmessage=message=>console.log("message",message)
  }

  function logError(err) {
  }

</script>
</body>

</html>
